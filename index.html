<!DOCTYPE html>
<html>
<head>
    <title>Diagnostic Experiment</title>
    <!--title>
          This is the advisor choice experiment with reliability changes
    </title> -->
    <script type="text/javascript">
        const chars = utils.shuffle(["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z","1","2","3","4","5","6","7","8","9"]);
        const participantID = (chars.slice(1,7)).join('');
        // redirect if we don't have consent for participation
        let consent = window.location.search.match("[?&]consent=true");
        if(consent === null) {
            let redirectURL = "consent.html";
            redirectURL += "&ParticipantID=" + participantID;
            window.location.replace(redirectURL); // simulate redirect (no history)
        }
    </script>
    <script src="/src/utils.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../style/styleIST.css"/>
    <link rel="shortcut icon" href="#" />
</head>
<body class="jspsych-display-element" tabindex="0" style="margin: 0; height: 100%; width: 100%;">
    <div class="jspsych-content-wrapper" style="height: 100vh;">
        <div id="jspsych-content" class="jspsych-content">
            <h1 id="initHeader">Loading...</h1>
            <p id="initText">If you continue to see this message after around 10 seconds, something has gone wrong. In order to run
                properly the experiment requires a modern browser with javascript enabled.</p>
        </div>
    </div>
<script type="module">
    // MAKE CHANGES BELOW
    // You can control the whole program for here by changing the value
    // of the parameters here.

    // (If there are comments next to the variable setting, you can change it.)
    // (If no comments, that variable is not functional yet so LEAVE IT AS IS!)

    const betaTest = true; // If true, only shows a single trial
    const doInstruct = true; // If true, shows instructions.
    const doTutorial = true; // If true, shows tutorial of how to use platform.
    const doQuestionnaire = true; // If true, includes questionnaires. 
    const demoQuestions = false; // If true, asks participants for age, gender and medical experience.
    const timeLimit = false; // If true, set a time limit for participants before they are forced to make a decision.
    const trialTime = 0; // If previous conditional is true, this is the amount of time (in seconds) allotted for each scenario.

    const scenarioFile = 'assets/image/human.jpg'; // filepath for where scenarios are defined.
    const endRedirectURL = 'https://bbc.co.uk'; //What URL to redirect to after the experiment.

    // - Show initial patient complaint
    // - Initial hypothesis generation and confidence
    // - Autopopulated list of diagnoses
    // - Define set of information tests
    // - Link file to retrival of information
    // - Button to lock in answer
    // - Provide final answer and confidence

    // Demographic data
    let yearsOfMedicalExperience;
    let gender;
    let age;
    let dateCompleted = utils.longformDate();

    // What independent and dependent data variables do we have? 

    let numOfTrials = scenarios.length;
    let hypothesisCondition = 0; // 0: no working diagnosis, 1: initial hypothesis provided, 2: free hypothesis generation
    let shuffledScenarios = utils.shuffle(scenarios);
    let scenarioOrder = shuffledScenarios.map(function(a) {return a.ID;});
    scenarioOrder = scenarioOrder.join('');

    // Trial level data
    let numOfTestsArray;
    let totalTestTimeArray;
    let trialTimeArray;
    let finalConfidenceArray;
    let subjDifficultyArray;

    // Aggregate data
    let correctTrials;
    let accuracy = correctTrials/numOfTrials;
    let meanNumOfTests;
    let meanTestTime;
    let meanTrialTime;
    let meanFinalConfidence;
    let meanSubjDifficulty;

    // Likelihood data?

    ////////////////////////////////////////////
    ////////////////////////////////////////////

    const conditionNames = ["Non-Directed", "Directed", "Generation"]
    var startExperimentTime = Date.now();


    let exp = new Structure({
        condition: hypothesisCondition,
        conditionName: conditionNames[hypothesisCondition],
        completionURL: endRedirectURL,
        timeStart: startExperimentTime,
        date: dateCompleted,
        order: scenarioOrder,
        scenarioObject: shuffledScenarios
    });


    const browserInstruct = {
        type: 'instructions',
        pages: ["<p>Please do not use the back or forward buttons on your browser during the experiment. Data on your performance will not save until the end of the experiment so do not close your browser unless you would no longer like to participate. Thank you for cooperation!</p>" + "<p>Press Next to begin.</p>"],
        show_clickable_nav: true
    };

    const welcome = {
        type: 'instructions',
         pages: [
             "<p>Hello and thank you for participating in this study! " +
             "In each trial of this task, you will be presented with a patient.</p>"+
             "<p>You can gather as much information as you want to diagnose the patient's condition" +
            "<p>Click 'next' to proceed.</p>"
        ],
        show_clickable_nav: true,
        on_load: ()=>exp.fullscreenMode(),
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    };

    const mainTrial = {
        type: 'diagnosis',
        on_load: ()=>{
            exp.fullscreenMode();
            exp.setupInterface(exp.currentTrial.trialInfoSet);
        }
    }


    jsPsych.init({
    timeline: timeline,
    preload_images: images,
    show_preload_progress_bar: true, // hide preload progress bar
    on_finish: function() {
      var endExperiment = Date.now();
      var expTime = msToMinSec(endExperiment - startExperiment);
      // add all experimental details to aggregateObject

    }
  });






</script>
</body>
</html>