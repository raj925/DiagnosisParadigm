<!DOCTYPE html>
<html>
<head>
    <title>Diagnostic Experiment</title>
    <!--title>
          This is the advisor choice experiment with reliability changes
    </title> -->
    <script src="/src/utils.js"></script>
    <script src="/src/scenarioFile.js"></script>
    <script src="/src/src.js"></script>
    <script type="text/javascript">
        const chars = shuffle(["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z","1","2","3","4","5","6","7","8","9"]);
        const participantID = (chars.slice(1,7)).join('');
        // redirect if we don't have consent for participation
        let consent = window.location.search.match("[?&]consent=true");
        if(consent === null) {
            let redirectURL = "consent.html";
            redirectURL += "?ParticipantID=" + participantID;
            window.location.replace(redirectURL); // simulate redirect (no history)
        }
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="/jspsych/dist/jspsych.js" type="text/javascript"></script>
    <script src="/jspsych/dist/plugin-image-button-response.js" type="text/javascript"></script>
    <script src="/jspsych/dist/plugin-instructions.js" type="text/javascript"></script>
    <script src="/jspsych/dist/plugin-survey-multi-choice.js" type="text/javascript"></script>
    <script src="/jspsych/dist/plugin-survey-multi-select.js" type="text/javascript"></script>
    <script src="/jspsych/dist/plugin-survey-multi-select-limit.js" type="text/javascript"></script>
    <script src="/jspsych/dist/plugin-survey-text.js" type="text/javascript"></script>
    <script src="/jspsych/dist/plugin-canvas-slider-response.js" type="text/javascript"></script>
    <link rel="stylesheet" href="../style/styleIST.css"/>
    <link rel="shortcut icon" href="#" />
</head>
<body class="jspsych-display-element" tabindex="0" style="margin: 0; height: 100%; width: 100%;">
    <div class="jspsych-content-wrapper" style="height: 100vh;">
        <div id="jspsych-content" class="jspsych-content">
            <h1 id="initHeader">Loading...</h1>
            <p id="initText">If you continue to see this message after around 10 seconds, something has gone wrong. In order to run
                properly the experiment requires a modern browser with javascript enabled.</p>
        </div>
    </div>
<script type="module">
    // MAKE CHANGES BELOW
    // You can control the whole program for here by changing the value
    // of the parameters here.

    // (If there are comments next to the variable setting, you can change it.)
    // (If no comments, that variable is not functional yet so LEAVE IT AS IS!)

    const betaTest = true; // If true, only shows a single trial
    const doInstruct = true; // If true, shows instructions.
    const doTutorial = true; // If true, shows tutorial of how to use platform.
    const doQuestionnaire = true; // If true, includes questionnaires. 
    const demoQuestions = false; // If true, asks participants for age, gender and medical experience.
    const doDebrief = false; // If true, run debrief questionnaire at the end.
    const timeLimit = false; // If true, set a time limit for participants before they are forced to make a decision.
    const trialTime = 0; // If previous conditional is true, this is the amount of time (in seconds) allotted for each scenario.
    const hypothesisGenerationTrials = true; // If true, run trials with starting part where participants say which diagnoses they are considering at the start.
    const doLikelihoodEstimates = true;
    const topXLikelihood = 3;

    const endRedirectURL = 'https://bbc.co.uk'; //What URL to redirect to after the experiment.

    // 1. Show extra options upon click at top level
    // 2. Show information when a test is performed
    // 3. Allow for recording of final diagnosis, with list
    // 4. Allow for generation of hypotheses at the start (need to add to scenario file for starting info)
    // 5. Confidence recording with final response
    // 6. Intermittently ask for likelihood of top N diagnoses
    // 7. Record clicks on tests
    // 8. Calculate overall fields
    // 9. Export data
    // 10. Debrief questionnaire
    // 11. Allow for different hypothesis modes (maybe add suggested hypothesis to data file)
    // 12. Demographic questionnaire (medical experience, gender, age)

    // Demographic data
    let yearsOfMedicalExperience;
    let gender;
    let age;
    let dateCompleted = longformDate();

    // What independent and dependent data variables do we have? 
    let hypothesisCondition = 0; // 0: no working diagnosis, 1: initial hypothesis provided, 2: free hypothesis generation
    let shuffledScenarios = shuffle(scenarios);
    let scenarioOrder = shuffledScenarios.map(function(a) {return a.ID;});
    scenarioOrder = scenarioOrder.join('');
    let buttons = shuffledScenarios[0];
    buttons = Object.keys(buttons);
    buttons.splice(buttons.indexOf("ID"), 1);
    buttons.splice(buttons.indexOf("True Condition"), 1);
    buttons.push("RECORD FINAL DIAGNOSIS")

    // Trial level data
    let numOfTestsArray;
    let totalTestTimeArray;
    let trialTimeArray;
    let finalConfidenceArray;
    let subjDifficultyArray;

    // Aggregate data
    let correctTrials;
    let meanNumOfTests;
    let meanTestTime;
    let meanTrialTime;
    let meanFinalConfidence;
    let meanSubjDifficulty;

    // Likelihood data?

    ////////////////////////////////////////////
    ////////////////////////////////////////////

    const conditionNames = ["Non-Directed", "Directed", "Generation"]
    let numOfScenarios = scenarios.length;
    var startExperimentTime = Date.now();
    let timeline = [];
    const queryString = window.location.search;
    var pid = queryString.split("ParticipantID=")[1];
    console.log(pid);


    let exp = new Structure({
    	numOfTrials: numOfScenarios,
    	currentTrialIndex: 0,
    	completionURL: endRedirectURL,
        timeStart: startExperimentTime,
        scenarioObject: shuffledScenarios,
        date: dateCompleted,
        order: scenarioOrder,
        condition: hypothesisCondition,
        conditionName: conditionNames[hypothesisCondition],
        complete: false,
        participantID: pid
    });
    
    const browserInstruct = {
        type: jsPsychInstructions,
        pages: ["<p>Please do not use the back or forward buttons on your browser during the experiment. Data on your performance will not save until the end of the experiment so do not close your browser unless you would no longer like to participate. Thank you for cooperation!</p>" + "<p>Press Next to begin.</p>"],
        show_clickable_nav: false,
        allow_backward: false
    };

    const welcome = {
        type: jsPsychInstructions,
         pages: [
             "<p>Hello and thank you for participating in this study! " +
             "In each trial of this task, you will be presented with a patient.</p>"+
             "<p>You can gather as much information as you want to diagnose the patient's condition" +
            "<p>Click 'next' to proceed.</p>"
        ],
        show_clickable_nav: true,
        allow_backward: false,
        on_load: ()=>exp.fullscreenMode(),
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    };

    const demoQuestionnaire = {
      type: jsPsychSurveyText,
      questions: [
        {prompt: 'Please input your age', required: true},
        {prompt: 'Please input your gender', required: true},
        {prompt: 'Please input how many years of medical experience you have', required: true}
      ],
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveQuestionnaire(trial);
        }
    }

    const hypothesisGeneration = {
        type: jsPsychSurveyMultiSelect,
        questions: [{
          prompt: "Choose from the list below any diagnoses you feel are plausible at this stage.", 
          name: 'initalDiagnoses', 
          options: shuffle(diagnoses), 
          required: true
        }],
        hozizontal: false,
        button_label: "Submit",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveHypotheses(trial);
        }
    }

    const infoSeeking = {
        type: jsPsychImageButtonResponse,
        stimulus: '',
    	choices: buttons,
    	response_ends_trial: false,
    	scenarioObject: exp.currentTrial.trialInfoSet,
    	prompt: "<p>Click a button to gather information or click RECORD FINAL DIAGNOSIS to report your final answer.</p>",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveInfoSeeking(trial);
        }
    }

    const likelihoodRank = {
        type: jsPsychSurveyMultiSelectLimit,
        questions: [{
          prompt: "Choose from the list below as to what your top " + topXLikelihood + " most likely diagnoses at this stage.", 
          name: 'initalDiagnoses', 
          options: shuffle(diagnoses), 
          required: true
        }],
        hozizontal: false,
        limit: topXLikelihood,
        button_label: "Submit",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveHypotheses(trial);
        }
        
    }

    const finalDiagnosis = {
        type: jsPsychSurveyMultiChoice,
        stimulus: '',
        questions: [{
          prompt: "Choose from the list below to record your final diagnosis.", 
          name: 'finalDiagnosis', 
          options: shuffle(diagnoses), 
          required: true
        }],
        button_label: "Submit",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveFinalDiagnosis(trial);
        }
    }

    const confidence = {
        type: jsPsychCanvasSliderResponse,
        stimulus: '',
        labels: ["Not At All Confident", "Fully Confident"],
        require_movement: false,
        prompt: "<p>Record your confidence in your diagnosis below.</p>",
        response_ends_trial: true,
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveConfidence(trial);
            exp.exportGovernor();
        }
    }

    const debrief = {
        type: jsPsychSurveyText,
        preamble: "Please take some time to answer a couple of final questions.",
        questions: ["What do you think this study was investigating?", "What was your general thought process when approaching this task?"],
        button_label: "Finish",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            jsPsych.finishTrial(trial);
        }
    }

    let trial = [infoSeeking, finalDiagnosis, confidence];

    if (hypothesisGenerationTrials == true)
    {
        trial.unshift(hypothesisGeneration);
    }

    timeline.push(welcome);

    if (demoQuestions == true)
    {
        timeline.push(demoQuestionnaire);
    }

    
    //timeline.push(regTrial);

    for (let i = 0; i < numOfScenarios; i++)
    {
    	timeline.push({timeline: trial});
    }

    if (doDebrief == true)
    {
        timeline.push(debrief);
    }


   	//const jsPsych = initJsPsych();
	const jsPsych = initJsPsych({
	  //preload_images: images,
	  show_preload_progress_bar: false,
	  on_finish: function(){
	  	var endExperimentTime = Date.now();
      	var expTime = msToMinSec(endExperimentTime - startExperimentTime);
	    jsPsych.data.displayData();
	}});

    jsPsych.run(timeline);

</script>
</body>
</html>