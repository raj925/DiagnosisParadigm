<!DOCTYPE html>
<html>
<head>
    <title>Diagnostic Experiment</title>
    <!--title>
          This experiment looks at information seeking and confidence in diagnostic decisions.
    </title> -->
    <script src="./src/utils.js"></script>
    <script src="./src/scenarioFile2.js"></script>
    <script src="./src/scenarioFileTutorial.js"></script>
    <script src="./src/src.js"></script>
    <script type="text/javascript">
        const chars = shuffle(["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z","1","2","3","4","5","6","7","8","9"]);
        const participantID = (chars.slice(1,7)).join('');
        // redirect if we don't have consent for participation
        const active = true;
        if (active)
        {
            let consent = window.location.search.match("[?&]consent=true");
            if(consent === null) {
                let redirectURL = "consent.html";
                redirectURL += "?ParticipantID=" + participantID;
                window.location.replace(redirectURL); // simulate redirect (no history)
            }
        }
        else
        {
            let redirectURL = "pause.html";
            window.location.replace(redirectURL); // simulate redirect (no history)
        }
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="./jspsych/dist/jspsych.js" type="text/javascript"></script>
    <script src="./jspsych/dist/plugin-image-button-response.js" type="text/javascript"></script>
    <script src="./jspsych/dist/plugin-instructions.js" type="text/javascript"></script>
    <script src="./jspsych/dist/plugin-survey-multi-choice.js" type="text/javascript"></script>
    <script src="./jspsych/dist/plugin-survey-multi-select.js" type="text/javascript"></script>
    <script src="./jspsych/dist/plugin-survey-multi-select-limit-sliders.js" type="text/javascript"></script>
    <script src="./jspsych/dist/plugin-survey-text.js" type="text/javascript"></script>
    <script src="./jspsych/dist/plugin-canvas-slider-response.js" type="text/javascript"></script>
    <script src="./jspsych/dist/plugin-canvas-slider-response-with-buttons.js" type="text/javascript"></script>
    <script src="./jspsych/dist/plugin-free-text-ranked-list.js" type="text/javascript"></script>
    <link rel="stylesheet" href="./style/styleIST.css"/>
    <link rel="shortcut icon" href="#" />
</head>
<body class="jspsych-display-element" tabindex="0" style="margin: 0; height: 100%; width: 100%;">
    <div class="jspsych-content-wrapper" style="height: 100vh;">
        <div id="jspsych-content" class="jspsych-content">
            <h1 id="initHeader">Loading...</h1>
            <p id="initText">If you continue to see this message after around 10 seconds, something has gone wrong. In order to run
                properly the experiment requires a modern browser with javascript enabled.</p>
        </div>
    </div>
<script type="module">
    // MAKE CHANGES BELOW
    // You can control the whole program for here by changing the value
    // of the parameters here.

    const betaTest = false; // If true, only shows a single trial
    const doInstruct = true; // If true, shows instructions.
    const doQuestionnaire = false; // If true, includes questionnaires. 
    const demoQuestions = true; // If true, asks participants for age, gender and medical experience.
    const doDebrief = true; // If true, run debrief questionnaire at the end.
    const doFeedback = true; //If true, shows what conditions all patients had at the end of the experiment.
    const timeLimit = false; // If true, set a time limit for participants before they are forced to make a decision.
    const doDifficulty = true; //If true, ask participants at the end of each trial how difficult they found the case.
    const trialTime = 0; // If previous conditional is true, this is the amount of time (in seconds) allotted for each scenario.
    const hypothesisGenerationTrials = false; // If true, run trials with starting part where participants say which diagnoses they are considering at the start.
    const informationStages = true; // If true, present information in discrete stages. If false, present all information at once.
    const numOfInformationStages = 3; // Number of stages that infomration is presented in. Only relevant if informationStages is true.
    const pastInformationAvailable = true; // If true, at each information stage, all information from the previous stage is available to view. If false, only the current stage's information is available.
    const randomiseTestOrder = true; // If true, shuffles the order of tests shown on screen for each trial and information stage. If false, the order is fixed to the order in which tests are shown in the scenario files.
    const runTutorial = true; // If true, runs a tutorial for the experiment before the main trials.

    //const endRedirectURL = 'https://www.oxstar.ox.ac.uk/'; //What URL to redirect to after the experiment.
    let URL = "end.html";
    let ID = window.location.search.match('[?&]ParticipantID=\\w+');
    ID = ID[0].substring(15);
    URL += "?ParticipantID=" + ID;
    const endRedirectURL = URL; //What URL to redirect to after the experiment.

    const sliderName = "Likelihood";
    const sliderLabels = ["Not At All Likely", "Extremely Likely"];
    const scaleName = "Level of Concern";
    //const scaleLabels = ["Not at All Concerned","Somewhat Concerned","Highly Concerned", "Emergency"];
    const scaleLabels = ["Low","Medium","High","Emergency"];
    const confidenceLabels = ["Not At All Confident", "Fully Confident"]
    const addButtonPrompt = "Enter the diagnosis that you want to add";
    const scaleError = "Please provide a severity for all diagnoses!"
    const hypothesisCondition = 0 // 0: no working diagnosis, 1: initial hypothesis provided, 2: free hypothesis generation


    ////////////////////////////////////////////
    ////////////////////////////////////////////

    let shuffledScenarios = shuffle(scenarios2); // load our scenarios from the scenario file and shuffle order.
    if (betaTest)
    {
        shuffledScenarios = [shuffledScenarios[0]];
    }
    let scenarioOrder;
    let buttons;
    let dateCompleted = Date.now();
    let feedback = "<p>Thank you again for participating in our experiment. You have completed all patient cases! Below, you will find the true conditions for these cases:</p>";
    for (let i = 0; i < shuffledScenarios.length; i ++)
    {
        let condition = shuffledScenarios[i]["True Condition"];
        feedback = feedback + "<p>Case " + (i+1) + ": " + condition;
    }

    if (betaTest)
    {
        scenarioOrder = shuffledScenarios[0].id;
    }
    else
    {
        scenarioOrder = shuffledScenarios.map(function(a) {return a.ID;}); //record the order that participants see the scenarios 
        scenarioOrder = scenarioOrder.join('');
    }
    buttons = shuffledScenarios[0]; // get the tests from the first scenario.
    buttons = Object.keys(buttons); // note this only works if all scenarios have same buttons/tests/information requests
    buttons.splice(buttons.indexOf("ID"), 1);
    buttons.splice(buttons.indexOf("True Condition"), 1);
    buttons.splice(buttons.indexOf("Prompt"), 1); // Remove scenario properties that are not buttons.
    buttons.splice(buttons.indexOf("Suspected"), 1);
    buttons.push("RECORD DIAGNOSIS"); // Add button to record final diagnosis.

    ////////////////////////////////////////////
    ////////////////////////////////////////////

    const jsPsych = initJsPsych({ // initialise JSPsych
      //preload_images: images,
      show_preload_progress_bar: false,
      on_finish: function(){
        var endExperimentTime = Date.now();
        var expTime = msToMinSec(endExperimentTime - startExperimentTime);
        jsPsych.data.displayData();
        window.location.replace(endRedirectURL);
    }});

    let numOfScenarios = shuffledScenarios.length;
    var conditions = [];
    if (hypothesisGenerationTrials) // if we have trials which start with generating differentials from little info.
    {
        conditions = Array(numOfScenarios).fill("Generation");
    }
    else // manipulation of starting prompt of working hypothesis to see how this affects differential generation. 
    {
        let split;
        if (betaTest)
        {
            conditions = ["Non-Directed"];
        }
        else
        {
           // conditions = Array(numOfScenarios/2).fill("Directed");
          //  conditions.push(Array(numOfScenarios/2).fill("Non-Directed"));
          //  conditions = conditions.flat();
          //  conditions = shuffle(conditions);
		conditions = Array(numOfScenarios).fill("Non-Directed");
        }
    }
    var startExperimentTime = Date.now();
    let timeline = [];
    const queryString = window.location.search;
    var pid = queryString.split("ParticipantID=")[1]; // get participant ID from the URL


    let exp = new Structure({ // main experiment object where we store data and then export for saving data.
    	numOfTrials: numOfScenarios,
        numOfSubtrials: numOfInformationStages,
    	currentTrialIndex: 0,
        currentSubtrialIndex: 0,
    	completionURL: endRedirectURL,
        timeStart: startExperimentTime,
        scenarioObject: shuffledScenarios,
        date: dateCompleted,
        order: scenarioOrder,
        expConditionOrder: conditions,
        trialsCompleted: 0,
        complete: false,
        participantID: pid
    });
    
    const browserInstruct = {
        type: jsPsychInstructions,
        pages: ["<p>Please do not use the back or forward buttons on your browser during the experiment. Data on your performance will not save until the end of the experiment so do not close your browser unless you would no longer like to participate. Thank you for cooperation!</p>" + "<p>Press Next to begin.</p>"],
        show_clickable_nav: true,
        allow_backward: false
    };

    const questionIntro = {
        type: jsPsychInstructions,
        pages: ["<p>Hello and thank you for participating in this study! " +
            "<p>Before getting started with the main study, you will first be completing some questions about your decision making style and personality. Please answer these as honestly as possible.</p>" +
            "<p>Click 'next' to proceed.</p>"],
        show_clickable_nav: true,
        allow_backward: false
    }

    const decisionQuestionnaire = 
    {
        type: jsPsychSurveyMultiChoice,
        preamble: "The following questions relate to how you make decisions. Please rate the following statements from Strongly Disagree to Strongly Agree:",
        questions:[
            {name: "RationalInfo", prompt: "I prefer to gather all the necessary information before committing to a decision. ", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]},
            {name: "RationalEval", prompt: "I thoroughly evaluate decision alternatives before making a final choice.", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]},
            {name: "RationalCont", prompt: "In decision making, I take time to contemplate the pros/cons or risks/benefits of a situation.", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]},
            {name: "RationalDecision", prompt: "Investigating the facts is an important part of my decision-making process.", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]},
            {name: "RationalWeigh", prompt: "I weigh a number of different factors when making decisions.", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]},
            {name: "IntuitiveGut", prompt: "When making decisions, I rely mainly on my gut feelings.", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]},
            {name: "IntuitiveHunch", prompt: "My initial hunch about decisions is generally what I follow.", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]},
            {name: "IntuitiveDecision", prompt: "I make decisions based on intuition.", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]},
            {name: "IntuitiveImpress", prompt: "I rely on my first impressions when making decisions.", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]},
            {name: "IntuitiveWeigh", prompt: "I weight feelings more than analysis in making decisions.", required: true, horizontal: true, options: ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"]}
        ],
        randomize_question_order: true,
        button_label: "Submit",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveDecisionQuestions(trial);
            jsPsych.finishTrial(trial);
        }
    }

    const bigFiveQuestionnaire = 
    {
        type: jsPsychSurveyMultiChoice,
        preamble: "For this survey, here are a number of characteristics that may or may not apply to you. For example, do you agree that you are someone who likes to spend time with others? Please rate each statement to indicate the extent to which you agree or disagree with that statement.",
        questions:[
            {name: "Talk", prompt: "I see myself as someone who is talkative.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Fault", prompt: "I see myself as someone who tends to find fault with others.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Thorough", prompt: "I see myself as someone who does a thorough job.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Blue", prompt: "I see myself as someone who is depressed, blue.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Orig", prompt: "I see myself as someone who is original, comes up with new ideas.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Reserved", prompt: "I see myself as someone who is reserved.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Help", prompt: "I see myself as someone who is helpful and unselfish with others.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Careless", prompt: "I see myself as someone who can be somewhat careless.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Relax", prompt: "I see myself as someone who is relaxed, handles stress well.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Curious", prompt: "I see myself as someone who is curious about many different things.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Energy", prompt: "I see myself as someone who is full of energy.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Quarrel", prompt: "I see myself as someone who starts quarrels with others.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Reliable", prompt: "I see myself as someone who is a reliable worker.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Tense", prompt: "I see myself as someone who can be tense.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Ingenious", prompt: "I see myself as someone who is ingenious, a deep thinker.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Enthusiastic", prompt: "I see myself as someone who generates a lot of enthusiasm.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Forgive", prompt: "I see myself as someone who has a forgiving nature.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Disorganise", prompt: "I see myself as someone who tends to be disorganised.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Worry", prompt: "I see myself as someone who worries a lot.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Active", prompt: "I see myself as someone who has an active imagination.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Quiet", prompt: "I see myself as someone who tends to be quiet.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Trusting", prompt: "I see myself as someone who is generally trusting.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Lazy", prompt: "I see myself as someone who tends to be lazy.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Stable", prompt: "I see myself as someone who is emotionally stable, not easily upset.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Inventive", prompt: "I see myself as someone who is inventive.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Assertive", prompt: "I see myself as someone who has an assertive personality.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Cold", prompt: "I see myself as someone who can be cold and aloof.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Persevere", prompt: "I see myself as someone who perseveres until the task is finished.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Moody", prompt: "I see myself as someone who can be moody.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Art", prompt: "I see myself as someone who values artistic, aesthetic experiences.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Shy", prompt: "I see myself as someone who is sometimes shy, inhibited.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Considerate", prompt: "I see myself as someone who is considerate and kind to almost everyone.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Efficient", prompt: "I see myself as someone who does things efficiently.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Calm", prompt: "I see myself as someone who remains calm in tense situations.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Routine", prompt: "I see myself as someone who prefers work that is routine.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Sociable", prompt: "I see myself as someone who is outgoing, sociable.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Rude", prompt: "I see myself as someone who is sometimes rude to others.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Plan", prompt: "I see myself as someone who makes plans and follows through with them.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Nervous", prompt: "I see myself as someone who gets nervous easily.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Ideas", prompt: "I see myself as someone who likes to reflect, play with ideas.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Artistic", prompt: "I see myself as someone who has few artistic interests.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Cooperate", prompt: "I see myself as someone who likes to cooperate with others.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Distract", prompt: "I see myself as someone who is easily distracted.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},
            {name: "Lit", prompt: "I see myself as someone who is sophisticated in art, music or literature.", required: true, horizontal: true, options: ["Disagree Strongly", "Disagree a little", "Neither agree nor disagree", "Agree a little", "Agree Strongly"]},

        ],
        randomize_question_order: true,
        button_label: "Submit",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveBigFiveQuestions(trial);
            jsPsych.finishTrial(trial);
        }
    }

    const welcome = {
        type: jsPsychInstructions,
         pages: [
             "<p>Thank you again for participating in this study! " +
             "<p>During the main task, imagine you are on call working in a busy district hospital. You will be presented with patients who are admitted into the hospital. Your task is to diagnose the condition that is causing the patient's symptoms. Please approach these cases as you would in your everyday medical practice. Your performance will be assessed based not only on the diagnosis you come to but also the number of tests you request. <strong>Hence, only request tests that are relevant to the case at hand.</strong></p>" + 
             "<p>You will start with a sample case as a tutorial for this study." +
            "<p>Click 'next' to proceed.</p>"
        ],
        show_clickable_nav: true,
        allow_backward: false,
        on_load: ()=>exp.fullscreenMode(),
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    };

    const demoQuestionnaire = {
      type: jsPsychSurveyText,
      questions: [
        {prompt: 'Please input your age', required: true},
        {prompt: 'Please input your gender', required: true},
        {prompt: 'Please input how many years of medical experience you have', required: true}
      ],
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveQuestionnaire(trial);
        }
    }

    const caseIntro = {
        type: jsPsychInstructions,
        pages: ["<p>For this case: " + exp.getCaseIntro()],
        show_clickable_nav: true,
        allow_backward: false,
        on_load: ()=>exp.fullscreenMode(),
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    }

    const hypothesisGeneration = {
        type: jsPsychSurveyMultiSelect,
        questions: [{
          prompt: "Choose from the list below any and all diagnoses you feel are plausible at this stage.", 
          name: 'initalDiagnoses', 
          options: shuffle(diagnoses), 
          required: true
        }],
        hozizontal: false,
        button_label: "Submit",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveHypotheses(trial);
        }
    }

    const tutorialCase = {
        type: jsPsychImageButtonResponse,
        stimulus: '',
        choices: buttons,
        response_ends_trial: false,
        scenarioObject: tutorialScenario,
        prompt: "<p>Below you will find a series of tests or information that you can request.</p><p>Information is split into three stages: Patient History, Physical Examination and Testing. To start with, only Patient History is available to view. Click on Patient History to view the available information requests. Clicking on each will reveal that information on screen. </p><p> When you are done seeking information and ready to record diagnoses for the patient, click on RECORD DIAGNOSIS.",
        shuffle_buttons: randomiseTestOrder,
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    }

    const infoSeeking = {
        type: jsPsychImageButtonResponse,
        stimulus: '',
    	choices: buttons,
    	response_ends_trial: false,
    	scenarioObject: exp.currentSubtrial.trialInfoSet,
    	prompt: "<p>Click a button to gather information or click RECORD DIAGNOSIS to report your final answer.</p>",
        shuffle_buttons: randomiseTestOrder,
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveInfoSeeking(trial);
        }
    }

    const finalDiagnosis = {
        type: jsPsychSurveyMultiChoice,
        stimulus: '',
        questions: [{
          prompt: "Choose from the list below to record your final diagnosis.", 
          name: 'finalDiagnosis', 
          options: shuffle(diagnoses), 
          required: true
        }],
        button_label: "Submit",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveFinalDiagnosis(trial);
        }
    }

    const confidence = {
        type: jsPsychCanvasSliderResponseWithButtons,
        stimulus: '',
        labels: confidenceLabels,
        require_movement: false,
        prompt: "<p>Record how confident you are that you would be ready to start treating this patient.</p>",
        response_ends_trial: true,
        text_prompt: "Record your treatment plan below.",
        text_placeholder: "Input your treatment plan (eg what further tests you would run, any advice or documentation you would seek)",
        text_rows: 10,
        text_columns: 30,
        text_name: "TreatmentPlan",
        scale_label: "Ready to Treat",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveConfidence(trial);
            exp.exportGovernor();
        }
    }

    const confidenceTreatment = {
        type: jsPsychCanvasSliderResponseWithButtons,
        stimulus: '',
        labels: confidenceLabels,
        require_movement: false,
        prompt: "<p>Record how confident you are that you would be ready to start treating this patient.</p>",
        response_ends_trial: true,
        text_prompt: "Record your treatment plan below.",
        text_placeholder: "Input your treatment plan (eg what further tests you would run, any advice or documentation you would seek)",
        text_rows: 10,
        text_columns: 30,
        text_name: "TreatmentPlan",
        scale_label: "Ready to Treat",
        hide_checkbox: false,
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveConfidence(trial);
            exp.exportGovernor();
        }
    }

    const confidenceTutorial = {
        type: jsPsychCanvasSliderResponseWithButtons,
        stimulus: '',
        labels: confidenceLabels,
        require_movement: false,
        prompt: "<p>Once you have recorded your diagnosis list, you should indicate using the slider how confident you are that you have the information you would need to be ready to treat this patient.</p><p>Bear in mind that there are three stages of information gathering left for this patient, so it is fine to not be very confident yet! Make sure that you are recording your confidence as accurately as possible: try not to be overconfident or underconfident.</p>",
        response_ends_trial: true,
        text_prompt: "Record your treatment plan below.",
        text_placeholder: "Input your treatment plan (eg what further tests you would run, any advice or documentation you would seek)",
        text_rows: 10,
        text_columns: 30,
        text_name: "TreatmentPlan",
        scale_label: "Ready to Treat",
        hide_checkbox: true,
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    }

    const perceivedDifficulty = {
        type: jsPsychCanvasSliderResponse,
        stimulus: '',
        labels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"],
        require_movement: false,
        prompt: "<p>On a scale from 1 (trivial) to 10 (impossible), how hard did you find it to determine a diagnosis for this case?</p>",
        min: 1,
        max: 10,
        step: 1,
        slider_start: 5,
        response_ends_trial: true,
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveDifficulty(trial);
            exp.exportGovernor();
        }
    }

    const differentialDiagnoses = 
    {
    	type: jsPsychFreeTextRankedList,
    	prompt: "<p>Input your diagnoses</p>",
        slider_labels: sliderLabels,
        slider_start: 5,
        slider_prompt: sliderName,
        slider_width:200,
        scale_questions: true,
        scale_labels: scaleLabels,
        scale_prompt: scaleName,
        add_button_prompt: addButtonPrompt,
        blank_scale_error: scaleError,
        draggable_list: false,
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveDifferentialDiagnoses(trial)
            exp.exportGovernor();
        }
    }

    const differentialDiagnosesTutorial = 
    {
        type: jsPsychFreeTextRankedList,
        prompt: "<p>At the end of each information stage, you will record a list of differential diagnoses for this patient.</p><p>Click the plus icon to add a diagnosis to the list. Once you type in the diagnosis, click the plus again or Enter on your keyboard. For each differential, you will record how severe this condition could be (Mild, Moderate or Severe) and how likely that diagnosis is on a scale of 1-10.</p><p>Try adding some diagnoses! Once you are done with your list, click Continue. Make sure that you have provided your level of concern and likelihood for all diagnoses before doing so.</p>",
        slider_labels: sliderLabels,
        slider_start: 5,
        slider_prompt: sliderName,
        slider_width:200,
        scale_questions: true,
        scale_labels: scaleLabels,
        scale_prompt: scaleName,
        add_button_prompt: addButtonPrompt,
        blank_scale_error: scaleError,
        draggable_list: false,
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    }

    const debrief = {
        type: jsPsychSurveyText,
        preamble: "Please take some time to answer a few final questions.",
        questions:[
            {name: "Hypothesis", prompt: "What do you think this study was investigating?", required: true, rows: 10,columns: 50},
            {name: "DiagnosticApproach", prompt: "What is your general approach to determining diagnoses?", required: true, rows: 10, columns: 50},
            {name: "Feedback", prompt: "To help improve this study for others, do you have any feedback on how this task simulates real life patient scenarios?", required: true, rows: 10, columns: 50}
        ],
        button_label: "Finish",
        on_load: ()=>{
            exp.fullscreenMode();
        },
        on_finish: (trial)=>{
            exp.saveDebrief(trial);
            jsPsych.finishTrial(trial);
        }
    }

    const preTutorialInstruct = {
        type: jsPsychInstructions,
         pages: [
             "<p>We will present you with a series of patient scenarios, whereby you will gather information and test results about the patient to determine the possible conditions that could be causing their symptoms.</p><p>You will start with an example case, which will follow the same procedure as the main patient cases. Your performance is not being recorded for this example case, as this is to allow you to familiarise yourself with the experiment flow and how the interface works.</p>"
        ],
        show_clickable_nav: true,
        allow_backward: false,
        on_load: ()=>exp.fullscreenMode(),
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    };

    const postTutorialInstruct = {
        type: jsPsychInstructions,
         pages: [
             "<p>You have completed the tutorial case! Feel free to take a short break before proceeding to the main experiment. The main patient cases will vary in difficulty, so do your best to report your differentials and report your confidence accurately.</p><p>One final tip: please try to imagine that you are encountering these patients in your everyday work. When making decisions about what information to request and which differential diagnoses you are considering, make sure you do so in a manner as close as possible to your everyday medical decisions.</p><p>Click Next to begin the experiment.</p>"
        ],
        show_clickable_nav: true,
        allow_backward: false,
        on_load: ()=>exp.fullscreenMode(),
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    };

    const showFeedback = {
        type: jsPsychInstructions,
        pages: [
        feedback
        ],
        show_clickable_nav: true,
        allow_backward: false,
        on_load: ()=>exp.fullscreenMode(),
        on_finish: (trial)=>{
            exp.fullscreenMode();
        }
    };

    let tutorialTrial;
    let trial;

    timeline.push(browserInstruct);
    if (demoQuestions)
    {
        timeline.push(demoQuestionnaire);
    }

    if (doQuestionnaire)
    {
        timeline.push(questionIntro);
        timeline.push(decisionQuestionnaire);
        timeline.push(bigFiveQuestionnaire);
    }

    timeline.push(welcome);

    // Define the tutorial 
    // We run through an example trial and add extra text to guide participants through the interface/paradigm.
    if (runTutorial)
    {
        tutorialTrial = [];
        let currentButtons = buttons;
        currentButtons.pop();

        //////////////////////////////////////////////
        // STAGE 1
        let stageButtons = []
        if (pastInformationAvailable)
        {
            stageButtons = currentButtons.slice(0,1);
        }
        else
        {
            stageButtons = currentButtons[0]
        }
        stageButtons.push("RECORD DIAGNOSIS");
        var tutorialStage1 = {
            type: jsPsychImageButtonResponse,
            stimulus: '',
            choices: stageButtons,
            response_ends_trial: false,
            scenarioObject: tutorialScenario,
            prompt: "<p>Above you will find a series of tests or information that you can request.</p><p>Information is split into three stages: Patient History, Physical Examination and Testing. To start with, only Patient History is available to view. Click on Patient History to view the available information requests. Clicking on each will reveal that information on screen. </p><p> When you are done seeking information and ready to record diagnoses for the patient, click on RECORD DIAGNOSIS.</p>",
            shuffle_buttons: randomiseTestOrder,
            on_load: ()=>{
                exp.fullscreenMode();
            },
            on_finish: (trial)=>{
                exp.fullscreenMode();
            }
        }

        tutorialTrial.push(tutorialStage1);
        tutorialTrial.push(differentialDiagnosesTutorial);
        tutorialTrial.push(confidenceTutorial);

        //////////////////////////////////////////////
        // STAGE 2
        if (pastInformationAvailable)
        {
            stageButtons = currentButtons.slice(0,2);
        }
        else
        {
            stageButtons = currentButtons[1]
        }
        stageButtons.push("RECORD DIAGNOSIS");
        var tutorialStage2 = {
            type: jsPsychImageButtonResponse,
            stimulus: '',
            choices: stageButtons,
            response_ends_trial: false,
            scenarioObject: tutorialScenario,
            prompt: "<p>You will now find that the next stage of information, <strong>Physical Examination</strong>, is available to view. Click here to view the available information requests. You can also go back to remind yourself of information about the Patient History. </p><p> When you are done seeking information and ready to record current diagnoses for the patient, click on RECORD DIAGNOSIS.</p>",
            shuffle_buttons: randomiseTestOrder,
            on_load: ()=>{
                exp.fullscreenMode();
            },
            on_finish: (trial)=>{
                exp.fullscreenMode();
            }
        }
        tutorialTrial.push(tutorialStage2);

        var differentialDiagnosesTutorialStage2 = {
            type: jsPsychFreeTextRankedList,
            prompt: "<p>You will notice that your diagnosis list from the first stage has been saved for you to now update given the extra information received via Physical Exmination of the patient.</p><p> As before, you can add diagnoses to the list using the plus icon.</p><p> <strong>If a diagnosis is no longer under consideration, you can use the cross icon on the right of the condition to remove it from the list. </strong> </p>",
            slider_labels: sliderLabels,
            slider_start: 5,
            slider_prompt: sliderName,
            slider_width:200,
            scale_questions: true,
            scale_labels: scaleLabels,
            scale_prompt: scaleName,
            add_button_prompt: addButtonPrompt,
            blank_scale_error: scaleError,
            start_empty: false,
            starting_list: function(){
                let array = jsPsych.data.get().last(3);
                return array.trials[0].response
            },
            starting_sliders: function(){
                let array = jsPsych.data.get().last(3);
                return array.trials[0].sliderValues
            },
            starting_scales: function(){
                let array = jsPsych.data.get().last(3);
                return array.trials[0].scaleValues
            },
            on_load: ()=>{
                exp.fullscreenMode();
            },
            on_finish: (trial)=>{
                exp.fullscreenMode();
            }
        }
        tutorialTrial.push(differentialDiagnosesTutorialStage2);
        tutorialTrial.push(confidenceTutorial);

        //////////////////////////////////////////////
        // STAGE 3
        if (pastInformationAvailable)
        {
            stageButtons = currentButtons.slice(0,3);
        }
        else
        {
            stageButtons = currentButtons[2]
        }
        stageButtons.push("RECORD DIAGNOSIS");
        var tutorialStage3 = {
            type: jsPsychImageButtonResponse,
            stimulus: '',
            choices: stageButtons,
            response_ends_trial: false,
            scenarioObject: tutorialScenario,
            prompt: "<p>Testing is now available, as well as the information from the previous two infomation stages.</p><p>This is the final stage of information gathering, where you can request test results, as well as all the previous information that has been made available about this patient.</p><p>For each patient case, you will have no limit to how much information you can gather. However, <strong> only request a piece of information if you believe it to be important for making your diagnostic decision.<p> When you are done seeking information and ready to record diagnoses for the patient, click on RECORD DIAGNOSIS.</p>",
            shuffle_buttons: randomiseTestOrder,
            on_load: ()=>{
                exp.fullscreenMode();
            },
            on_finish: (trial)=>{
                exp.fullscreenMode();
            }
        }
        tutorialTrial.push(tutorialStage3);

        var differentialDiagnosesTutorialStage3 = {
                    type: jsPsychFreeTextRankedList,
                    prompt: "<p>This is your last chance to record differential diagnoses for this patient. You can record multiple differentials, and you can record in your treatment plan on the next page what further actions you would take to reduce this list further.</p><p><strong>When you are recording diagnoses during patient cases, record ANY conditions that you are considering. Even if they are a remote possiblity, they are worth recording.</strong></p>",
                    slider_labels: sliderLabels,
                    slider_start: 5,
                    slider_prompt: sliderName,
                    slider_width:200,
                    scale_questions: true,
                    scale_labels: scaleLabels,
                    scale_prompt: scaleName,
                    add_button_prompt: addButtonPrompt,
                    blank_scale_error: scaleError,
                    start_empty: false,
                    starting_list: function(){
                        let array = jsPsych.data.get().last(3);
                        return array.trials[0].response
                    },
                    starting_sliders: function(){
                        let array = jsPsych.data.get().last(3);
                        return array.trials[0].sliderValues
                    },
                    starting_scales: function(){
                        let array = jsPsych.data.get().last(3);
                        return array.trials[0].scaleValues
                    },
                    on_load: ()=>{
                        exp.fullscreenMode();
                    },
                    on_finish: (trial)=>{
                        exp.fullscreenMode();
                    }
        }
        tutorialTrial.push(differentialDiagnosesTutorialStage3);

        const confidenceTutorialStage3 = {
            type: jsPsychCanvasSliderResponseWithButtons,
            stimulus: '',
            labels: confidenceLabels,
            require_movement: false,
            prompt: "<p>You can record your final confidence here, as well as whether you are ready to start treating the patient using the checkbox. As before, you can record your confidence using the slider</p><p><strong>If you believe you are ready to start treating the patient, you can check the box below that says 'Ready to Treat'.</strong> If you do, you will be asked to record what your treatment plan would be. Please include details such as any escalations you would make, any further tests you would run, consultants/specialists or documentation you would consult and generally what your immediate course of action would be.</p>",
            response_ends_trial: true,
            text_prompt: "Record your treatment plan below.",
            text_placeholder: "Input your treatment plan (eg what further tests you would run, any advice or documentation you would seek)",
            text_rows: 10,
            text_columns: 30,
            text_name: "TreatmentPlan",
            scale_label: "Ready to Treat",
            hide_checkbox: false,
            on_load: ()=>{
                exp.fullscreenMode();
            },
            on_finish: (trial)=>{
                exp.fullscreenMode();
            }
        }
        tutorialTrial.push(confidenceTutorialStage3);

        timeline.push(preTutorialInstruct);
        timeline.push({timeline: tutorialTrial});
        timeline.push(postTutorialInstruct);
    }

    if (hypothesisGenerationTrials)
    {
        trial.unshift(hypothesisGeneration);
    }

    //trial.unshift(caseIntro);


    for (let x = 0; x < numOfScenarios; x++)
    {
        var currentCaseIntro = {
            type: jsPsychInstructions,
            pages: ["<p>For this case: " + shuffledScenarios[x].Prompt],
            show_clickable_nav: true,
            allow_backward: false,
            on_load: ()=>exp.fullscreenMode(),
            on_finish: (trial)=>{
                exp.fullscreenMode();
            }
        }
        timeline.push(currentCaseIntro);
        if (informationStages)
        {
            trial = [];
            let currentButtons = buttons;
           // currentButtons.pop();
            for (let i = 1;i<numOfInformationStages+1;i++)
            {
                let stageButtons = []
                if (pastInformationAvailable)
                {
                    stageButtons = currentButtons.slice(0,i);
                }
                else
                {
                    stageButtons = currentButtons[i-1]
                }
                stageButtons.push("RECORD DIAGNOSIS");
                var infoSeekingStage = {
                    type: jsPsychImageButtonResponse,
                    stimulus: '',
                    choices: stageButtons,
                    response_ends_trial: false,
                    scenarioObject: shuffledScenarios[x],
                    prompt: "<p>Click a button to gather information or click RECORD DIAGNOSIS to report your final answer.</p>",
                    shuffle_buttons: randomiseTestOrder,
                    on_load: ()=>{
                        exp.fullscreenMode();
                    },
                    on_finish: (trial)=>{
                        exp.saveInfoSeeking(trial);
                    }
                }
                trial.push(infoSeekingStage);
                if (i==1)
                {
                    trial.push(differentialDiagnoses);
                }
                else
                {
                    var differentialDiagnosesStage = {
                        type: jsPsychFreeTextRankedList,
                        prompt: "<p>Input your diagnoses</p>",
                        slider_labels: sliderLabels,
                        slider_start: 5,
                        slider_prompt: sliderName,
                        slider_width:200,
                        scale_questions: true,
                        scale_labels: scaleLabels,
                        scale_prompt: scaleName,
                        add_button_prompt: addButtonPrompt,
                        blank_scale_error: scaleError,
                        start_empty: false,
                        starting_list: function(){ // We need to load the differentials, slider and scale values from last subtrial/stage.
                            let array = jsPsych.data.get().last(3);
                            return array.trials[0].response
                        },
                        starting_sliders: function(){
                            let array = jsPsych.data.get().last(3);
                            return array.trials[0].sliderValues
                        },
                        starting_scales: function(){
                            let array = jsPsych.data.get().last(3);
                            return array.trials[0].scaleValues
                        },
                        on_load: ()=>{
                            exp.fullscreenMode();
                        },
                        on_finish: (trial)=>{
                            exp.saveDifferentialDiagnoses(trial)
                            exp.exportGovernor();
                        }
                    }
                    trial.push(differentialDiagnosesStage);
                }

                if (i == numOfInformationStages)
                {
                    trial.push(confidenceTreatment);
                }
                else
                {
                    trial.push(confidence);
                } 
            }
        }   
        else
        {
            trial = [infoSeeking, differentialDiagnoses, finalDiagnosis, confidence];
        }
    	timeline.push({timeline: trial});
        if (doDifficulty)
        {
            timeline.push(perceivedDifficulty);
        }
    }

    if (doFeedback)
    {
        timeline.push(showFeedback);
    }
    
    if (doDebrief)
    {
        timeline.push(debrief);
    }

    jsPsych.run(timeline);

</script>
</body>
</html>
